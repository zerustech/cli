#!/bin/bash

# This file is part of the ZerusTech HTTP Cache Tutorial package.
# 
# (c) Michael Lee <michael.lee@zerustech.com>
#
# For the full copyright and license information, please view the LICENSE file 
# that was distributed with this source code.

base=`cd $(dirname $BASH_SOURCE) && pwd` && source $base/../../lib/varnish.sh

# This script starts and stops varnish cache servers from command line.
# 
# @author Michael Lee <michael.lee@zerustech.com>

: ${http_socket:=""}
: ${varnish_socket:=""}
: ${key_file:=""}
: ${config_file:=""}
: ${pid_file:=""}
: ${varnish_home:=""}
: ${var:="$base/../../var"}

function usage()
{
    printf "varnish-service: usage: varnish-service -h varnish_home -f config_file -S varnish_key_file -a http_host:http_socket -T varnish_host:varnish_port start [arguments ...]\n"
    printf "varnish-service: usage: varnish-service -b varnish_host:varnish_port stop\n"
    exit 0
}

while getopts "h:f:S:a:T:" opt; do

    case $opt in

        h) varnish_home="$OPTARG";;

        f) config_file="$OPTARG";;

        S) key_file="$OPTARG";;

        a) http_socket="$OPTARG";;

        T) varnish_socket="$OPTARG";;

        *) usage;;

    esac

done

shift $((OPTIND - 1))

pid_file="$var/varnish-$varnish_socket.pid"

command=$1

shift

if [ "$command" == "start" ]; then

    if [ "$varnish_home" == "" ] || [ "$config_file" == "" ] || [ "$key_file" == "" ] || [ "$http_socket" == "" ] || [ "$varnish_socket" == "" ]; then

        usage

    fi

fi

if [ "$command" == "stop" ]; then

    if [ "$varnish_socket" == "" ]; then

        usage

    fi

fi

case $command in

    start) varnish_start "$varnish_home" "$http_socket" "$varnish_socket" "$key_file" "$config_file" "$pid_file" "$@";;

     stop) varnish_stop "$pid_file";;

        *) usage;;
esac

printf "\n\n"
